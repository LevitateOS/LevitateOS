# TEAM_452: Investigate Container DNS/Network Issue

## Status: FIXED âœ…

## Bug Report

**Symptom:** All containers (podman, distrobox) cannot reach the internet. Network requests fail with "temporary error (try again later)".

**Environment:**
- Host OS: Fedora Linux
- Container runtime: Podman
- Distrobox for container management
- Tailscale was installed (now stopped)

**Error observed:**
```
WARNING: fetching https://dl-cdn.alpinelinux.org/alpine/v3.20/main: temporary error (try again later)
```

**Key observation:**
- Host can reach internet fine: `curl -I https://dl-cdn.alpinelinux.org` works
- Containers cannot: same curl fails inside container
- Container resolv.conf shows Tailscale DNS servers even after stopping Tailscale:
  ```
  nameserver 169.254.1.1
  nameserver 100.100.100.100
  ```

## Phase 1: Understand the Symptom

### Expected Behavior
Containers should be able to resolve DNS and reach the internet.

### Actual Behavior
Containers use stale Tailscale DNS servers that are unreachable after Tailscale is stopped.

### Delta
DNS resolution inside containers fails because resolv.conf points to dead Tailscale DNS.

## Phase 2: Hypotheses

1. **H1: System resolv.conf still has Tailscale DNS** (HIGH confidence)
   - Evidence needed: Check /etc/resolv.conf on host
   - Refute: If host resolv.conf has working DNS

2. **H2: Podman caches DNS config at container creation** (MEDIUM confidence)
   - Evidence needed: Check podman network config
   - Refute: If recreating containers doesn't help

3. **H3: systemd-resolved still configured for Tailscale** (HIGH confidence)
   - Evidence needed: Check resolvectl status
   - Refute: If systemd-resolved shows correct DNS

4. **H4: NetworkManager DNS settings point to Tailscale** (MEDIUM confidence)
   - Evidence needed: Check nmcli dns settings
   - Refute: If NM shows correct DNS

## Phase 3: Evidence Gathering

**Host /etc/resolv.conf before fix:**
```
# resolv.conf(5) file generated by tailscale
nameserver 100.100.100.100
search tail5bea38.ts.net
```

**resolvectl status showed:**
- Global DNS pointing to Tailscale (100.100.100.100)
- But network interfaces had correct DNS (192.168.178.84)

**NetworkManager had correct DNS** - the issue was Tailscale's override.

## Phase 4: Root Cause

**CONFIRMED:** Tailscale overwrote `/etc/resolv.conf` with its own DNS servers. When Tailscale was stopped, the file remained pointing to dead DNS (100.100.100.100).

Containers inherit DNS from `/etc/resolv.conf`, so they couldn't resolve anything.

## Phase 5: Fix

**Applied fix:**
```bash
sudo rm /etc/resolv.conf
sudo ln -s /run/systemd/resolve/stub-resolv.conf /etc/resolv.conf
```

This restores systemd-resolved as the DNS manager, which correctly uses the network interface DNS servers.

**Verification:** Alpine container can now fetch packages and reach the internet.

## Prevention

If you need to use Tailscale again in the future, be aware it will override `/etc/resolv.conf`. When stopping Tailscale, you may need to restore the symlink manually.
